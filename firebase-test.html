<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Firebase Test - ProfPilot</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    .status-success { background-color: #10b981; }
    .status-error { background-color: #ef4444; }
    .status-warning { background-color: #f59e0b; }
  </style>
</head>
<body class="bg-slate-50 min-h-screen">
  <!-- Header -->
  <header class="bg-white shadow-sm border-b border-slate-200">
    <div class="max-w-4xl mx-auto px-4 py-4">
      <div class="flex items-center justify-between">
        <h1 class="text-2xl font-bold text-slate-900">üî• Firebase Test</h1>
        <a href="/" class="text-blue-600 hover:text-blue-700 font-medium">‚Üê Back to Home</a>
      </div>
    </div>
  </header>

  <!-- Main Content -->
  <main class="max-w-4xl mx-auto px-4 py-8">
    
    <!-- Connection Status -->
    <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-6 mb-6">
      <h2 class="text-xl font-semibold text-slate-900 mb-4">Connection Status</h2>
      <div id="connection-status" class="space-y-2">
        <div class="flex items-center gap-2">
          <div class="w-3 h-3 rounded-full bg-gray-400" id="firebase-status"></div>
          <span id="firebase-text">Checking Firebase...</span>
        </div>
        <div class="flex items-center gap-2">
          <div class="w-3 h-3 rounded-full bg-gray-400" id="firestore-status"></div>
          <span id="firestore-text">Checking Firestore...</span>
        </div>
      </div>
    </div>

    <!-- Test Operations -->
    <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-6 mb-6">
      <h2 class="text-xl font-semibold text-slate-900 mb-4">Test Operations</h2>
      
      <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <!-- Create Test Record -->
        <div class="border border-slate-200 rounded-lg p-4">
          <h3 class="font-medium text-slate-900 mb-2">Create Test Record</h3>
          <p class="text-sm text-slate-600 mb-3">Create a test payment record in Firestore</p>
          <button id="create-test" class="w-full bg-blue-600 text-white py-2 px-4 rounded-lg hover:bg-blue-700 transition-colors">
            Create Test Record
          </button>
          <div id="create-result" class="mt-2 text-sm"></div>
        </div>

        <!-- Read Records -->
        <div class="border border-slate-200 rounded-lg p-4">
          <h3 class="font-medium text-slate-900 mb-2">Read Records</h3>
          <p class="text-sm text-slate-600 mb-3">Read all payment records from Firestore</p>
          <button id="read-records" class="w-full bg-green-600 text-white py-2 px-4 rounded-lg hover:bg-green-700 transition-colors">
            Read Records
          </button>
          <div id="read-result" class="mt-2 text-sm"></div>
        </div>

        <!-- Update Record -->
        <div class="border border-slate-200 rounded-lg p-4">
          <h3 class="font-medium text-slate-900 mb-2">Update Record</h3>
          <p class="text-sm text-slate-600 mb-3">Update the last created record</p>
          <button id="update-record" class="w-full bg-yellow-600 text-white py-2 px-4 rounded-lg hover:bg-yellow-700 transition-colors">
            Update Record
          </button>
          <div id="update-result" class="mt-2 text-sm"></div>
        </div>

        <!-- Delete Records -->
        <div class="border border-slate-200 rounded-lg p-4">
          <h3 class="font-medium text-slate-900 mb-2">Clean Up</h3>
          <p class="text-sm text-slate-600 mb-3">Delete all test records</p>
          <button id="delete-records" class="w-full bg-red-600 text-white py-2 px-4 rounded-lg hover:bg-red-700 transition-colors">
            Delete Test Records
          </button>
          <div id="delete-result" class="mt-2 text-sm"></div>
        </div>

        <!-- Check Rules -->
        <div class="border border-slate-200 rounded-lg p-4">
          <h3 class="font-medium text-slate-900 mb-2">Check Rules</h3>
          <p class="text-sm text-slate-600 mb-3">Test Firestore security rules</p>
          <button id="check-rules" class="w-full bg-purple-600 text-white py-2 px-4 rounded-lg hover:bg-purple-700 transition-colors">
            Check Firestore Rules
          </button>
          <div id="rules-result" class="mt-2 text-sm"></div>
        </div>
      </div>
    </div>

    <!-- Records Display -->
    <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-6">
      <h2 class="text-xl font-semibold text-slate-900 mb-4">Records in Database</h2>
      <div id="records-display" class="space-y-2">
        <p class="text-slate-500">No records loaded yet. Click "Read Records" to load data.</p>
      </div>
    </div>

  </main>

  <!-- Firebase Scripts -->
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>
  <script src="firebase-config.js"></script>
  <script src="firebase-init.js"></script>
  <script src="check-firestore-rules.js"></script>

  <script>
    let lastCreatedId = null;

    // Check connection status
    function checkConnectionStatus() {
      const firebaseStatus = document.getElementById('firebase-status');
      const firebaseText = document.getElementById('firebase-text');
      const firestoreStatus = document.getElementById('firestore-status');
      const firestoreText = document.getElementById('firestore-text');

      // Check Firebase
      if (typeof firebase !== 'undefined') {
        firebaseStatus.className = 'w-3 h-3 rounded-full status-success';
        firebaseText.textContent = 'Firebase SDK loaded';
      } else {
        firebaseStatus.className = 'w-3 h-3 rounded-full status-error';
        firebaseText.textContent = 'Firebase SDK not loaded';
      }

      // Check Firestore
      if (typeof firebase !== 'undefined' && firebase.firestore) {
        firestoreStatus.className = 'w-3 h-3 rounded-full status-success';
        firestoreText.textContent = 'Firestore ready';
      } else {
        firestoreStatus.className = 'w-3 h-3 rounded-full status-error';
        firestoreText.textContent = 'Firestore not available';
      }
    }

    // Create test record
    document.getElementById('create-test').addEventListener('click', async function() {
      const resultDiv = document.getElementById('create-result');
      resultDiv.textContent = 'Creating...';
      resultDiv.className = 'mt-2 text-sm text-blue-600';

      try {
        const db = firebase.firestore();
        const testData = {
          userId: 'test@example.com',
          simulator: 'ux-designer',
          amount: 29.00,
          currency: 'USD',
          status: 'test',
          createdAt: firebase.firestore.FieldValue.serverTimestamp(),
          testRecord: true
        };

        const docRef = await db.collection('purchases').add(testData);
        lastCreatedId = docRef.id;
        
        resultDiv.textContent = `‚úÖ Test record created with ID: ${docRef.id}`;
        resultDiv.className = 'mt-2 text-sm text-green-600';
      } catch (error) {
        resultDiv.textContent = `‚ùå Error: ${error.message}`;
        resultDiv.className = 'mt-2 text-sm text-red-600';
      }
    });

    // Read records
    document.getElementById('read-records').addEventListener('click', async function() {
      const resultDiv = document.getElementById('read-result');
      const displayDiv = document.getElementById('records-display');
      
      resultDiv.textContent = 'Reading...';
      resultDiv.className = 'mt-2 text-sm text-blue-600';

      try {
        const db = firebase.firestore();
        const snapshot = await db.collection('purchases').orderBy('createdAt', 'desc').get();
        
        resultDiv.textContent = `‚úÖ Found ${snapshot.size} records`;
        resultDiv.className = 'mt-2 text-sm text-green-600';

        // Display records
        if (snapshot.empty) {
          displayDiv.innerHTML = '<p class="text-slate-500">No records found.</p>';
        } else {
          let html = '';
          snapshot.forEach(doc => {
            const data = doc.data();
            html += `
              <div class="border border-slate-200 rounded-lg p-3">
                <div class="flex justify-between items-start mb-2">
                  <span class="font-medium text-slate-900">${doc.id}</span>
                  <span class="text-xs text-slate-500">${data.createdAt ? data.createdAt.toDate().toLocaleString() : 'No date'}</span>
                </div>
                <div class="text-sm text-slate-600">
                  <div>User: ${data.userId}</div>
                  <div>Simulator: ${data.simulator}</div>
                  <div>Amount: $${data.amount}</div>
                  <div>Status: ${data.status}</div>
                  ${data.testRecord ? '<div class="text-yellow-600 font-medium">Test Record</div>' : ''}
                </div>
              </div>
            `;
          });
          displayDiv.innerHTML = html;
        }
      } catch (error) {
        resultDiv.textContent = `‚ùå Error: ${error.message}`;
        resultDiv.className = 'mt-2 text-sm text-red-600';
        displayDiv.innerHTML = '<p class="text-red-600">Error loading records.</p>';
      }
    });

    // Update record
    document.getElementById('update-record').addEventListener('click', async function() {
      const resultDiv = document.getElementById('update-result');
      
      if (!lastCreatedId) {
        resultDiv.textContent = '‚ùå No record to update. Create a record first.';
        resultDiv.className = 'mt-2 text-sm text-red-600';
        return;
      }

      resultDiv.textContent = 'Updating...';
      resultDiv.className = 'mt-2 text-sm text-blue-600';

      try {
        const db = firebase.firestore();
        await db.collection('purchases').doc(lastCreatedId).update({
          status: 'confirmed',
          updatedAt: firebase.firestore.FieldValue.serverTimestamp()
        });
        
        resultDiv.textContent = '‚úÖ Record updated successfully';
        resultDiv.className = 'mt-2 text-sm text-green-600';
      } catch (error) {
        resultDiv.textContent = `‚ùå Error: ${error.message}`;
        resultDiv.className = 'mt-2 text-sm text-red-600';
      }
    });

    // Delete records
    document.getElementById('delete-records').addEventListener('click', async function() {
      const resultDiv = document.getElementById('delete-result');
      resultDiv.textContent = 'Deleting...';
      resultDiv.className = 'mt-2 text-sm text-blue-600';

      try {
        const db = firebase.firestore();
        const snapshot = await db.collection('purchases').where('testRecord', '==', true).get();
        
        const batch = db.batch();
        snapshot.forEach(doc => {
          batch.delete(doc.ref);
        });
        
        await batch.commit();
        
        resultDiv.textContent = `‚úÖ Deleted ${snapshot.size} test records`;
        resultDiv.className = 'mt-2 text-sm text-green-600';
        
        // Clear display
        document.getElementById('records-display').innerHTML = '<p class="text-slate-500">No records loaded yet. Click "Read Records" to load data.</p>';
      } catch (error) {
        resultDiv.textContent = `‚ùå Error: ${error.message}`;
        resultDiv.className = 'mt-2 text-sm text-red-600';
      }
    });

    // Check rules
    document.getElementById('check-rules').addEventListener('click', async function() {
      const resultDiv = document.getElementById('rules-result');
      resultDiv.textContent = 'Checking rules...';
      resultDiv.className = 'mt-2 text-sm text-blue-600';

      try {
        if (window.runFirebaseCheck) {
          await window.runFirebaseCheck();
          resultDiv.textContent = '‚úÖ Rules check completed. Check console for details.';
          resultDiv.className = 'mt-2 text-sm text-green-600';
        } else {
          resultDiv.textContent = '‚ùå Rules checker not loaded';
          resultDiv.className = 'mt-2 text-sm text-red-600';
        }
      } catch (error) {
        resultDiv.textContent = `‚ùå Error: ${error.message}`;
        resultDiv.className = 'mt-2 text-sm text-red-600';
      }
    });

    // Initialize
    document.addEventListener('DOMContentLoaded', function() {
      checkConnectionStatus();
      
      // Check again after Firebase loads
      setTimeout(checkConnectionStatus, 2000);
    });
  </script>
</body>
</html>